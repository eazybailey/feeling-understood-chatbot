<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Feeling Understood Chatbot</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect } = React;

    // UPDATE THIS URL after deploying to Vercel
    const API_ENDPOINT = 'https://feeling-understood-chatbot.vercel.app/api/chat';

    const MessageCircle = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
      </svg>
    );

    const Send = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <line x1="22" y1="2" x2="11" y2="13"></line>
        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
      </svg>
    );

    const FeelingUnderstoodChatbot = () => {
      const [messages, setMessages] = useState([
        {
          role: 'assistant',
          content: "Welcome. This is a safe space to explore what it means to feel understoodâ€”and what happens when we don't.\n\nThink about the people who matter most to you. How well do you feel understood by them?",
          options: [
            "I often feel understood",
            "Sometimes I do, sometimes I don't",
            "I rarely feel understood",
            "I'd rather describe it in my own words"
          ]
        }
      ]);
      const [input, setInput] = useState('');
      const [isLoading, setIsLoading] = useState(false);
      const [showOptions, setShowOptions] = useState(true);
      const messagesEndRef = useRef(null);

      const scrollToBottom = () => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      };

      useEffect(() => {
        scrollToBottom();
      }, [messages]);

      const systemPrompt = `You are an empathetic conversation guide for a project about feeling understood. Your role is to help people explore their experiences of feeling understood or misunderstood in their relationships.

Key principles:
- Be warm, compassionate, and non-judgmental
- NEVER give advice. Your role is to listen, reflect, and help people articulate their feelings
- Use active listening techniques: reflect back what you hear, validate emotions, ask clarifying questions
- Help users identify which aspects of their identity they feel misunderstood about (needs, capabilities, role in relationships, values, worldview, ambitions, concerns, etc.)
- When appropriate, gently introduce concepts from the "5 Ways to Feel Understood":
  1. When not feeling understood, say so
  2. Take responsibility for being understood
  3. Ask for help in communicating better
  4. Take your turn in conversations
  5. Always check understanding rather than assume it
- Periodically offer brief summaries of what you've heard to help the user feel understood
- Create a safe space for exploration and self-discovery
- Keep responses conversational and not too long (2-4 sentences usually)
- The goal is for users to feel heard and to gain insight into their communication patterns

Remember: This is about helping people understand themselves better and practice expressing their feelings in a no-jeopardy environment.`;

      const handleOptionClick = async (option) => {
        setShowOptions(false);
        await sendMessage(option);
      };

      const sendMessage = async (messageText = input) => {
        if (!messageText.trim()) return;

        const userMessage = { role: 'user', content: messageText };
        setMessages(prev => [...prev, userMessage]);
        setInput('');
        setIsLoading(true);

        try {
          const conversationHistory = [...messages, userMessage].map(msg => ({
            role: msg.role,
            content: msg.content
          }));

          const response = await fetch(API_ENDPOINT, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              system: systemPrompt,
              messages: conversationHistory
            })
          });

          const data = await response.json();
          const assistantMessage = data.content
            .filter(item => item.type === 'text')
            .map(item => item.text)
            .join('\n');

          setMessages(prev => [...prev, {
            role: 'assistant',
            content: assistantMessage
          }]);
        } catch (error) {
          console.error('Error:', error);
          setMessages(prev => [...prev, {
            role: 'assistant',
            content: "I'm having trouble connecting right now. Please try again in a moment."
          }]);
        } finally {
          setIsLoading(false);
        }
      };

      const handleKeyPress = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      };

      return (
        <div className="flex flex-col h-screen bg-gradient-to-br from-blue-50 to-green-50">
          <div className="bg-white shadow-sm border-b border-gray-200 p-4">
            <div className="max-w-4xl mx-auto flex items-center gap-3">
              <div className="w-10 h-10 bg-gradient-to-br from-blue-400 to-green-400 rounded-full flex items-center justify-center">
                <MessageCircle />
              </div>
              <div>
                <h1 className="text-xl font-semibold text-gray-800">Feeling Understood</h1>
                <p className="text-sm text-gray-500">A safe space for exploration</p>
              </div>
            </div>
          </div>

          <div className="flex-1 overflow-y-auto p-4">
            <div className="max-w-4xl mx-auto space-y-6">
              {messages.map((message, index) => (
                <div key={index} className={`flex ${message.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                  <div className={`max-w-2xl ${
                    message.role === 'user' 
                      ? 'bg-blue-500 text-white' 
                      : 'bg-white text-gray-800 shadow-sm'
                  } rounded-2xl px-5 py-3`}>
                    <p className="whitespace-pre-wrap leading-relaxed">{message.content}</p>
                    
                    {message.options && showOptions && index === messages.length - 1 && (
                      <div className="mt-4 space-y-2">
                        {message.options.map((option, optIndex) => (
                          <button
                            key={optIndex}
                            onClick={() => handleOptionClick(option)}
                            className="w-full text-left px-4 py-2 bg-blue-50 hover:bg-blue-100 text-blue-700 rounded-lg transition-colors text-sm"
                          >
                            {option}
                          </button>
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              ))}
              
              {isLoading && (
                <div className="flex justify-start">
                  <div className="bg-white rounded-2xl px-5 py-3 shadow-sm">
                    <div className="flex gap-2">
                      <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '0ms' }}></div>
                      <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '150ms' }}></div>
                      <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '300ms' }}></div>
                    </div>
                  </div>
                </div>
              )}
              
              <div ref={messagesEndRef} />
            </div>
          </div>

          <div className="bg-white border-t border-gray-200 p-4">
            <div className="max-w-4xl mx-auto">
              <div className="flex gap-2">
                <input
                  type="text"
                  value={input}
                  onChange={(e) => setInput(e.target.value)}
                  onKeyPress={handleKeyPress}
                  placeholder="Share your thoughts..."
                  className="flex-1 px-4 py-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent"
                  disabled={isLoading}
                />
                <button
                  onClick={() => sendMessage()}
                  disabled={isLoading || !input.trim()}
                  className="w-12 h-12 bg-gradient-to-br from-blue-500 to-green-500 text-white rounded-full flex items-center justify-center hover:from-blue-600 hover:to-green-600 transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-md"
                >
                  <Send />
                </button>
              </div>
              <p className="text-xs text-gray-500 text-center mt-2">
                This is a judgment-free space. Your conversation stays private.
              </p>
            </div>
          </div>
        </div>
      );
    };

    ReactDOM.render(<FeelingUnderstoodChatbot />, document.getElementById('root'));
  </script>
</body>
</html>